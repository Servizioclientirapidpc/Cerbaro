<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crea Preventivo - Cerbaro</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Arial:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f8f9fa;
        }
        .material-row {
            margin-bottom: 10px;
            padding: 10px;
            background-color: #f0f0f0;
            border-radius: 5px;
        }
        .articolo-section {
            margin-bottom: 20px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: white;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <h1 class="text-center mb-4">Crea Preventivo</h1>
        
        <form id="formPreventivo">
            <!-- Dati Cliente -->
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Dati Cliente</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="nomeCliente" class="form-label">Nome Cliente/Azienda *</label>
                                <input type="text" class="form-control" id="nomeCliente" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="indirizzoCliente" class="form-label">Indirizzo</label>
                                <input type="text" class="form-control" id="indirizzoCliente">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="cittaCliente" class="form-label">Città</label>
                                <input type="text" class="form-control" id="cittaCliente">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="capCliente" class="form-label">CAP</label>
                                <input type="text" class="form-control" id="capCliente">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="provinciaCliente" class="form-label">Provincia</label>
                                <input type="text" class="form-control" id="provinciaCliente" maxlength="2">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Dati Preventivo -->
            <div class="card mb-4">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0">Dati Preventivo</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="dataPreventivo" class="form-label">Data</label>
                                <input type="date" class="form-control" id="dataPreventivo" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="oggettoPreventivo" class="form-label">Oggetto *</label>
                                <input type="text" class="form-control" id="oggettoPreventivo" required>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Articoli -->
            <div class="card mb-4">
                <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Articoli</h5>
                    <button type="button" class="btn btn-light btn-sm" onclick="aggiungiArticolo()">
                        + Aggiungi Articolo
                    </button>
                </div>
                <div class="card-body" id="articoliContainer">
                    <!-- Gli articoli verranno aggiunti qui -->
                </div>
            </div>

            <!-- Pulsanti -->
            <div class="text-center mb-5">
                <button type="button" class="btn btn-primary btn-lg me-2" onclick="generaPDF()">
                    Genera PDF
                </button>
                <button type="button" class="btn btn-secondary btn-lg" onclick="window.location.href='index.html'">
                    Annulla
                </button>
            </div>
        </form>
    </div>

    <script>
        // Materiali disponibili (hardcoded per ora)
        const materialiDB = [
            { id: 1, codice: 'MP001', nome: 'Ferro', prezzo_kg: 2.50 },
            { id: 2, codice: 'MP002', nome: 'Alluminio', prezzo_kg: 3.80 },
            { id: 3, codice: 'MP003', nome: 'PVC', prezzo_kg: 1.60 },
            { id: 4, codice: 'MP004', nome: 'Legno', prezzo_kg: 2.20 },
            { id: 5, codice: 'MP005', nome: 'Inox', prezzo_kg: 5.00 },
            { id: 6, codice: 'MP006', nome: 'Vetro', prezzo_kg: 4.50 }
        ];

        let numeroArticolo = 0;
        const costoOrario = 30;

        // Inizializzazione
        document.addEventListener('DOMContentLoaded', function() {
            // Imposta data odierna
            document.getElementById('dataPreventivo').value = new Date().toISOString().split('T')[0];
            // Aggiungi primo articolo
            aggiungiArticolo();
        });

        // Funzione per aggiungere articolo
        function aggiungiArticolo() {
            numeroArticolo++;
            const container = document.getElementById('articoliContainer');
            
            const articoloHtml = `
                <div class="articolo-section" id="articolo_${numeroArticolo}">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6>Articolo ${numeroArticolo}</h6>
                        <button type="button" class="btn btn-danger btn-sm" onclick="rimuoviArticolo(${numeroArticolo})">
                            Rimuovi
                        </button>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Descrizione</label>
                        <input type="text" class="form-control" id="descrizione_${numeroArticolo}" required>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Ore Lavoro</label>
                        <input type="number" class="form-control" id="ore_${numeroArticolo}" 
                               min="0" step="0.5" value="0" onchange="calcolaTotaleArticolo(${numeroArticolo})">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Materiali</label>
                        <div id="materiali_${numeroArticolo}">
                            <button type="button" class="btn btn-sm btn-outline-primary" 
                                    onclick="aggiungiMateriale(${numeroArticolo})">
                                + Aggiungi Materiale
                            </button>
                        </div>
                    </div>
                    
                    <div class="text-end">
                        <strong>Totale Articolo: € <span id="totale_${numeroArticolo}">0.00</span></strong>
                    </div>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', articoloHtml);
        }

        // Funzione per rimuovere articolo
        function rimuoviArticolo(id) {
            const articolo = document.getElementById(`articolo_${id}`);
            if (articolo && document.querySelectorAll('.articolo-section').length > 1) {
                articolo.remove();
            }
        }

        // Funzione per aggiungere materiale
        function aggiungiMateriale(articoloId) {
            const container = document.getElementById(`materiali_${articoloId}`);
            const materialeId = `materiale_${articoloId}_${Date.now()}`;
            
            const options = materialiDB.map(m => 
                `<option value="${m.id}">${m.nome} (€${m.prezzo_kg}/kg)</option>`
            ).join('');
            
            const materialeHtml = `
                <div class="material-row d-flex gap-2" id="${materialeId}">
                    <select class="form-select" style="flex: 2" onchange="calcolaTotaleArticolo(${articoloId})">
                        <option value="">Seleziona materiale</option>
                        ${options}
                    </select>
                    <input type="number" class="form-control" placeholder="Quantità (kg)" 
                           style="flex: 1" min="0" step="0.1" onchange="calcolaTotaleArticolo(${articoloId})">
                    <button type="button" class="btn btn-sm btn-danger" 
                            onclick="document.getElementById('${materialeId}').remove(); calcolaTotaleArticolo(${articoloId})">
                        ×
                    </button>
                </div>
            `;
            
            // Inserisci prima del pulsante "Aggiungi Materiale"
            const button = container.querySelector('button');
            button.insertAdjacentHTML('beforebegin', materialeHtml);
        }

        // Funzione per calcolare totale articolo
        function calcolaTotaleArticolo(articoloId) {
            let totale = 0;
            
            // Ore lavoro
            const ore = parseFloat(document.getElementById(`ore_${articoloId}`).value) || 0;
            totale += ore * costoOrario;
            
            // Materiali
            const materialiContainer = document.getElementById(`materiali_${articoloId}`);
            const righe = materialiContainer.querySelectorAll('.material-row');
            
            righe.forEach(riga => {
                const select = riga.querySelector('select');
                const input = riga.querySelector('input[type="number"]');
                const materialeId = parseInt(select.value);
                const quantita = parseFloat(input.value) || 0;
                
                if (materialeId && quantita > 0) {
                    const materiale = materialiDB.find(m => m.id === materialeId);
                    if (materiale) {
                        totale += materiale.prezzo_kg * quantita;
                    }
                }
            });
            
            document.getElementById(`totale_${articoloId}`).textContent = totale.toFixed(2);
        }

        // Funzione per generare PDF
        async function generaPDF() {
            try {
                console.log('Inizio generazione PDF...');
                
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Raccogli dati
                const datiPreventivo = raccogliDatiPreventivo();
                console.log('Dati raccolti:', datiPreventivo);
                
                // Variabili per posizionamento
                let yPos = 20;
                const pageHeight = doc.internal.pageSize.height;
                const pageWidth = doc.internal.pageSize.width;
                
                // Funzione per aggiungere watermark
                function aggiungiWatermark() {
                    doc.setTextColor(240, 240, 240);
                    doc.setFontSize(60);
                    doc.text('CERBARO', pageWidth/2, pageHeight/2, {
                        align: 'center',
                        angle: 45
                    });
                    doc.setTextColor(0, 0, 0);
                }
                
                // Prima pagina - Preventivo
                aggiungiWatermark();
                
                // Header
                doc.setFontSize(24);
                doc.setTextColor(255, 0, 0);
                doc.text('CERBARO', pageWidth/2, yPos, { align: 'center' });
                doc.setTextColor(0, 0, 0);
                
                yPos += 10;
                doc.setFontSize(10);
                doc.text('Via Lago di Bracciano, 17 - 36015 Schio (VI)', pageWidth/2, yPos, { align: 'center' });
                yPos += 5;
                doc.text('Tel: 0445575494 - Email: info@cerbaro.it', pageWidth/2, yPos, { align: 'center' });
                
                // Linea divisoria
                yPos += 10;
                doc.line(20, yPos, pageWidth - 20, yPos);
                
                // Data e cliente
                yPos += 15;
                doc.setFontSize(11);
                doc.text(`Data: ${datiPreventivo.data}`, 20, yPos);
                doc.text('Spett.le', pageWidth - 60, yPos);
                
                yPos += 8;
                doc.setFont(undefined, 'bold');
                doc.text(datiPreventivo.cliente.nome, pageWidth - 60, yPos);
                doc.setFont(undefined, 'normal');
                
                if (datiPreventivo.cliente.indirizzo) {
                    yPos += 6;
                    doc.text(datiPreventivo.cliente.indirizzo, pageWidth - 60, yPos);
                }
                
                if (datiPreventivo.cliente.citta) {
                    yPos += 6;
                    doc.text(`${datiPreventivo.cliente.cap || ''} ${datiPreventivo.cliente.citta} ${datiPreventivo.cliente.provincia || ''}`.trim(), pageWidth - 60, yPos);
                }
                
                // Oggetto
                yPos += 20;
                doc.setFont(undefined, 'bold');
                doc.text('Oggetto:', 20, yPos);
                doc.setFont(undefined, 'normal');
                doc.text(datiPreventivo.oggetto, 45, yPos);
                
                yPos += 15;
                doc.text('Di seguito nostra migliore offerta:', 20, yPos);
                
                // Tabella articoli
                yPos += 15;
                
                // Header tabella
                doc.setFillColor(240, 240, 240);
                doc.rect(20, yPos - 5, pageWidth - 40, 8, 'F');
                doc.setFont(undefined, 'bold');
                doc.text('Pos.', 25, yPos);
                doc.text('Descrizione', 40, yPos);
                doc.text('Totale €', pageWidth - 40, yPos, { align: 'right' });
                doc.setFont(undefined, 'normal');
                
                yPos += 10;
                
                // Articoli
                let totalePreventivo = 0;
                datiPreventivo.articoli.forEach((articolo, index) => {
                    // Controllo nuova pagina
                    if (yPos > pageHeight - 50) {
                        doc.addPage();
                        aggiungiWatermark();
                        yPos = 30;
                    }
                    
                    // Posizione e descrizione
                    doc.text(`${index + 1}`, 25, yPos);
                    doc.setFont(undefined, 'bold');
                    doc.text(articolo.descrizione || `Articolo ${index + 1}`, 40, yPos);
                    doc.text(articolo.totale.toFixed(2), pageWidth - 40, yPos, { align: 'right' });
                    doc.setFont(undefined, 'normal');
                    
                    yPos += 6;
                    
                    // Dettagli materiali
                    articolo.materiali.forEach(mat => {
                        if (mat.quantita > 0) {
                            doc.setFontSize(9);
                            doc.text(`• ${mat.nome}: ${mat.quantita} kg`, 45, yPos);
                            yPos += 5;
                        }
                    });
                    
                    // Ore lavoro
                    if (articolo.ore > 0) {
                        doc.setFontSize(9);
                        doc.text(`• Ore lavoro: ${articolo.ore}`, 45, yPos);
                        yPos += 5;
                    }
                    
                    doc.setFontSize(11);
                    yPos += 5;
                    totalePreventivo += articolo.totale;
                });
                
                // Linea totale
                yPos += 5;
                doc.line(20, yPos, pageWidth - 20, yPos);
                yPos += 10;
                
                // Totale
                doc.setFont(undefined, 'bold');
                doc.setFontSize(14);
                doc.text(`TOTALE iva esclusa: € ${totalePreventivo.toFixed(2)}`, pageWidth - 20, yPos, { align: 'right' });
                
                // Footer prima pagina
                const footerY = pageHeight - 20;
                doc.setFontSize(8);
                doc.setFont(undefined, 'normal');
                doc.line(20, footerY - 5, pageWidth - 20, footerY - 5);
                doc.text('CERBARO CERBARO MATTEO GIOVANNI', pageWidth/2, footerY, { align: 'center' });
                doc.text('Via Lago di Bracciano n. 17 - 36015 Schio (VI) - P.IVA: 03641800241', pageWidth/2, footerY + 4, { align: 'center' });
                doc.text('Pagina 1 di 3', pageWidth - 20, footerY + 8, { align: 'right' });
                
                // Seconda pagina - Condizioni commerciali 1
                doc.addPage();
                aggiungiWatermark();
                
                yPos = 30;
                doc.setFontSize(16);
                doc.setFont(undefined, 'bold');
                doc.text('CONDIZIONI COMMERCIALI', pageWidth/2, yPos, { align: 'center' });
                
                yPos += 20;
                doc.setFontSize(11);
                doc.setFont(undefined, 'normal');
                
                const condizioni1 = [
                    { titolo: 'PAGAMENTO', testo: 'Bonifico bancario 30 gg data fattura fine mese.' },
                    { titolo: 'CONSEGNA', testo: 'Da concordare - Franco nostro stabilimento.' },
                    { titolo: 'TRASPORTO', testo: 'A carico del committente.' },
                    { titolo: 'VALIDITÀ OFFERTA', testo: '30 giorni dalla data del presente preventivo.' },
                    { titolo: 'GARANZIA', testo: '24 mesi dalla data di consegna su difetti di fabbricazione.' },
                    { titolo: 'IMBALLO', testo: 'Compreso nel prezzo.' }
                ];
                
                condizioni1.forEach(cond => {
                    if (yPos > pageHeight - 40) {
                        doc.addPage();
                        aggiungiWatermark();
                        yPos = 30;
                    }
                    
                    doc.setFont(undefined, 'bold');
                    doc.text(cond.titolo + ':', 20, yPos);
                    yPos += 6;
                    doc.setFont(undefined, 'normal');
                    
                    // Gestione testo lungo
                    const lines = doc.splitTextToSize(cond.testo, pageWidth - 60);
                    lines.forEach(line => {
                        doc.text(line, 30, yPos);
                        yPos += 6;
                    });
                    yPos += 4;
                });
                
                // Footer seconda pagina
                doc.setFontSize(8);
                doc.line(20, footerY - 5, pageWidth - 20, footerY - 5);
                doc.text('CERBARO CERBARO MATTEO GIOVANNI', pageWidth/2, footerY, { align: 'center' });
                doc.text('Via Lago di Bracciano n. 17 - 36015 Schio (VI) - P.IVA: 03641800241', pageWidth/2, footerY + 4, { align: 'center' });
                doc.text('Pagina 2 di 3', pageWidth - 20, footerY + 8, { align: 'right' });
                
                // Terza pagina - Condizioni commerciali 2
                doc.addPage();
                aggiungiWatermark();
                
                yPos = 30;
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text('NOTE IMPORTANTI', 20, yPos);
                
                yPos += 15;
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                
                const note = [
                    '• I prezzi si intendono IVA esclusa',
                    '• Il materiale resta di nostra proprietà fino al completo pagamento',
                    '• Per accettazione del presente preventivo, restituire copia firmata',
                    '• Eventuali variazioni in corso d\'opera saranno concordate separatamente',
                    '• Il presente preventivo è stato redatto sulla base delle informazioni fornite',
                    '• Misure e quantità da verificare in cantiere prima dell\'ordine definitivo'
                ];
                
                note.forEach(nota => {
                    doc.text(nota, 25, yPos);
                    yPos += 8;
                });
                
                // Spazio per firma
                yPos = pageHeight - 80;
                doc.text('Per accettazione:', 20, yPos);
                yPos += 20;
                doc.text('Data: _____________________', 20, yPos);
                doc.text('Firma: _____________________', pageWidth/2, yPos);
                
                // Footer terza pagina
                doc.setFontSize(8);
                doc.line(20, footerY - 5, pageWidth - 20, footerY - 5);
                doc.text('CERBARO CERBARO MATTEO GIOVANNI', pageWidth/2, footerY, { align: 'center' });
                doc.text('Via Lago di Bracciano n. 17 - 36015 Schio (VI) - P.IVA: 03641800241', pageWidth/2, footerY + 4, { align: 'center' });
                doc.text('Pagina 3 di 3', pageWidth - 20, footerY + 8, { align: 'right' });
                
                // Salva PDF
                const nomeFile = `Preventivo_${datiPreventivo.cliente.nome.replace(/\s+/g, '_')}_${new Date().getTime()}.pdf`;
                doc.save(nomeFile);
                
                console.log('PDF generato con successo!');
                alert('PDF generato con successo!');
                
            } catch (error) {
                console.error('Errore nella generazione del PDF:', error);
                alert('Si è verificato un errore nella generazione del PDF. Controlla la console per dettagli.');
            }
        }
        
        // Funzione per raccogliere dati del preventivo
        function raccogliDatiPreventivo() {
            const dati = {
                data: new Date(document.getElementById('dataPreventivo').value).toLocaleDateString('it-IT'),
                cliente: {
                    nome: document.getElementById('nomeCliente').value || 'Cliente',
                    indirizzo: document.getElementById('indirizzoCliente').value || '',
                    citta: document.getElementById('cittaCliente').value || '',
                    cap: document.getElementById('capCliente').value || '',
                    provincia: document.getElementById('provinciaCliente').value || ''
                },
                oggetto: document.getElementById('oggettoPreventivo').value || 'Preventivo',
                articoli: []
            };
            
            // Raccogli articoli
            document.querySelectorAll('.articolo-section').forEach((articoloEl, index) => {
                const id = articoloEl.id.split('_')[1];
                const articolo = {
                    descrizione: document.getElementById(`descrizione_${id}`)?.value || `Articolo ${index + 1}`,
                    ore: parseFloat(document.getElementById(`ore_${id}`)?.value) || 0,
                    materiali: [],
                    totale: 0
                };
                
                // Raccogli materiali
                const materialiContainer = document.getElementById(`materiali_${id}`);
                if (materialiContainer) {
                    materialiContainer.querySelectorAll('.material-row').forEach(riga => {
                        const select = riga.querySelector('select');
                        const input = riga.querySelector('input[type="number"]');
                        const materialeId = parseInt(select.value);
                        const quantita = parseFloat(input.value) || 0;
                        
                        if (materialeId && quantita > 0) {
                            const materiale = materialiDB.find(m => m.id === materialeId);
                            if (materiale) {
                                articolo.materiali.push({
                                    nome: materiale.nome,
                                    quantita: quantita,
                                    prezzo_unitario: materiale.prezzo_kg
                                });
                                articolo.totale += materiale.prezzo_kg * quantita;
                            }
                        }
                    });
                }
                
                // Aggiungi costo ore lavoro
                articolo.totale += articolo.ore * costoOrario;
                
                dati.articoli.push(articolo);
            });
            
            return dati;
        }
    </script>
</body>
</html>